# Copyright 2025 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

from pathlib import Path

import transaction
from zope.component import getUtility
from zope.security.proxy import removeSecurityProxy

from lp.app.enums import InformationType
from lp.app.interfaces.launchpad import ILaunchpadCelebrities
from lp.bugs.enums import VulnerabilityHandlerEnum
from lp.bugs.interfaces.vulnerabilityjob import (
    IImportVulnerabilityJob,
    IImportVulnerabilityJobSource,
    VulnerabilityJobException,
    VulnerabilityJobInProgress,
)
from lp.bugs.model.importvulnerabilityjob import ImportVulnerabilityJob
from lp.code.tests.helpers import GitHostingFixture
from lp.services.features.testing import FeatureFixture
from lp.services.job.interfaces.job import JobStatus
from lp.services.job.tests import block_on_job
from lp.testing import TestCaseWithFactory, person_logged_in
from lp.testing.layers import CeleryJobLayer, DatabaseFunctionalLayer


class ImportVulnerabilityJobTests(TestCaseWithFactory):
    """Test case for ImportVulnerabilityJob."""

    layer = DatabaseFunctionalLayer

    def setUp(self):
        super().setUp()
        self.repository = self.factory.makeGitRepository()
        self.refs = self.factory.makeGitRefs(
            repository=self.repository,
            paths=("ref/heads/main", "ref/tags/v1.0"),
        )
        self.cve_path = (
            Path(__file__).parent
            / ".."
            / ".."
            / "bugs"
            / "scripts"
            / "soss"
            / "tests"
            / "sampledata"
            / "CVE-2025-1979"
        )

    @property
    def job_source(self):
        return getUtility(IImportVulnerabilityJobSource)

    def test_getOopsVars(self):
        """Test getOopsVars method."""
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        vars = job.getOopsVars()
        naked_job = removeSecurityProxy(job)
        self.assertIn(("vulnerabilityjob_job_id", naked_job.id), vars)
        self.assertIn(
            ("vulnerability_job_type", naked_job.job_type.title), vars
        )
        self.assertIn(("handler", naked_job.handler), vars)

    def _getJobs(self):
        """Return the pending IImportVulnerabilityJob as a list."""
        return list(IImportVulnerabilityJob.iterReady())

    def _getJobCount(self):
        """Return the number of IImportVulnerabilityJob in the
        queue."""
        return len(self._getJobs())

    def test___repr__(self):
        """Test __repr__ method."""
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None
        metadata = {
            "request": {
                "git_repository": git_repository,
                "git_ref": git_ref,
                "git_paths": git_paths,
                "information_type": information_type,
                "import_since_commit_sha1": import_since_commit_sha1,
            },
            "result": {
                "error_description": [],
                "succeeded": [],
                "failed": [],
            },
        }

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )

        expected = (
            "<ImportVulnerabilityJob for "
            f"handler: {handler}, "
            f"metadata: {metadata}"
            ">"
        )
        self.assertEqual(expected, repr(job))

    def test_create_with_existing_pending_job(self):
        """If there's already a waiting/running/suspended
        ImportVulnerabilityJob for the handler ImportVulnerabilityJob.create()
        raises the VulnerabilityJobInProgress exception.
        """
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None

        # Job WAITING status
        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        waiting_exception = self.assertRaises(
            VulnerabilityJobInProgress,
            self.job_source.create,
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        self.assertEqual(job, waiting_exception.job)

        # Job status from WAITING to RUNNING
        job.start()
        running_exception = self.assertRaises(
            VulnerabilityJobInProgress,
            self.job_source.create,
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        self.assertEqual(job, running_exception.job)

        # Job status from RUNNING to SUSPENDED
        job.suspend()
        running_exception = self.assertRaises(
            VulnerabilityJobInProgress,
            self.job_source.create,
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        self.assertEqual(job, running_exception.job)

    def test_create_with_existing_completed_job(self):
        """If there's already a completed ImportVulnerabilityJob for the
        handler the job can be run again.
        """
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        job.start()
        job.complete()
        self.assertEqual(job.status, JobStatus.COMPLETED)

        job_duplicated = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        job_duplicated.start()
        job_duplicated.complete()
        self.assertEqual(job_duplicated.status, JobStatus.COMPLETED)

        # There's a 3rd run to check that the query returns only pending jobs,
        # and one() doesn't raise an exception
        job_duplicated = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        job_duplicated.start()
        job_duplicated.complete()
        self.assertEqual(job_duplicated.status, JobStatus.COMPLETED)

    def test_create_with_existing_failed_job(self):
        """If there's a failed ImportVulnerabilityJob for the handler the job
        can be run again.
        """
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        job.start()
        job.fail()
        self.assertEqual(job.status, JobStatus.FAILED)

        job_duplicated = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        job_duplicated.start()
        job_duplicated.complete()
        self.assertEqual(job_duplicated.status, JobStatus.COMPLETED)

    def test_arguments(self):
        """Test that ImportVulnerabilityJob specified with arguments can
        be gotten out again."""
        git_repository = self.factory.makeGitRepository()
        self.useFixture(GitHostingFixture(blob=b"Some text"))

        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None
        metadata = {
            "request": {
                "git_repository": git_repository,
                "git_ref": git_ref,
                "git_paths": git_paths,
                "information_type": information_type,
                "import_since_commit_sha1": import_since_commit_sha1,
            },
            "result": {
                "error_description": [],
                "succeeded": [],
                "failed": [],
            },
        }

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )

        naked_job = removeSecurityProxy(job)
        self.assertEqual(naked_job.handler, handler)
        self.assertEqual(naked_job.git_repository, git_repository)
        self.assertEqual(naked_job.git_ref, git_ref)
        self.assertEqual(naked_job.git_paths, git_paths)
        self.assertEqual(naked_job.information_type, information_type)
        self.assertEqual(
            naked_job.import_since_commit_sha1, import_since_commit_sha1
        )
        self.assertEqual(naked_job.metadata, metadata)

    def test_run_import(self):
        """Run ImportVulnerabilityJob."""
        with open(self.cve_path, encoding="utf-8") as file:
            self.useFixture(
                GitHostingFixture(
                    blob=file.read(),
                    refs=self.refs,
                    diff_stats={"added": ["cves/CVE-2025-1979"]},
                )
            )

        cve = self.factory.makeCVE("2025-1979")
        self.factory.makeDistribution(name="soss")

        job = self.job_source.create(
            handler=VulnerabilityHandlerEnum.SOSS,
            git_repository=self.repository.git_https_url,
            git_ref="ref/tags/v1.0",
            git_paths=["cves"],
            information_type=InformationType.PRIVATESECURITY.value,
            import_since_commit_sha1=None,
        )
        job.run()

        # Check that it created the bug and vulnerability
        self.assertEqual(len(cve.bugs), 1)

        admin = getUtility(ILaunchpadCelebrities).admin
        with person_logged_in(admin):
            self.assertEqual(len(list(cve.vulnerabilities)), 1)

        self.assertEqual(
            job.metadata.get("result"),
            {
                "succeeded": ["CVE-2025-1979"],
                "failed": [],
                "error_description": [],
            },
        )

    def test_run_import_with_wrong_git_paths(self):
        """Run ImportVulnerabilityJob with wrong git_paths."""
        with open(self.cve_path, encoding="utf-8") as file:
            self.useFixture(
                GitHostingFixture(
                    blob=file.read(),
                    refs=self.refs,
                    diff_stats={"added": ["cves/CVE-2025-1979"]},
                )
            )

        cve = self.factory.makeCVE("2025-1979")
        self.factory.makeDistribution(name="soss")

        job = self.job_source.create(
            handler=VulnerabilityHandlerEnum.SOSS,
            git_repository=self.repository.git_https_url,
            git_ref="ref/tags/v1.0",
            git_paths=["wrong_path"],
            information_type=InformationType.PRIVATESECURITY.value,
            import_since_commit_sha1=None,
        )
        job.run()

        # Check that it did not create the bug and vulnerability
        self.assertEqual(len(cve.bugs), 0)

        admin = getUtility(ILaunchpadCelebrities).admin
        with person_logged_in(admin):
            self.assertEqual(len(list(cve.vulnerabilities)), 0)

        self.assertEqual(
            job.metadata.get("result"),
            {
                "succeeded": [],
                "failed": [],
                "error_description": [],
            },
        )

    def test_run_import_with_wrong_git_repository(self):
        """Run ImportVulnerabilityJob with wrong git_repository."""
        self.factory.makeCVE("2025-1979")
        self.factory.makeDistribution(name="soss")

        job = self.job_source.create(
            handler=VulnerabilityHandlerEnum.SOSS,
            git_repository="wrong_url",
            git_ref="ref/heads/main",
            git_paths=["cves"],
            information_type=InformationType.PRIVATESECURITY.value,
            import_since_commit_sha1=None,
        )

        self.assertRaises(VulnerabilityJobException, job.run)

        self.assertEqual(
            job.metadata.get("result"),
            {
                "succeeded": [],
                "failed": [],
                "error_description": ["Git repository not found"],
            },
        )

    def test_run_import_with_wrong_git_ref(self):
        """Run ImportVulnerabilityJob with wrong git_ref."""
        with open(self.cve_path, encoding="utf-8") as file:
            self.useFixture(
                GitHostingFixture(
                    blob=file.read(),
                    refs=self.refs,
                    diff_stats={"added": ["cves/CVE-2025-1979"]},
                )
            )

        self.factory.makeCVE("2025-1979")
        self.factory.makeDistribution(name="soss")

        job = self.job_source.create(
            handler=VulnerabilityHandlerEnum.SOSS,
            git_repository=self.repository.git_https_url,
            git_ref="ref/heads/wrong-ref",
            git_paths=["cves"],
            information_type=InformationType.PRIVATESECURITY.value,
            import_since_commit_sha1=None,
        )

        self.assertRaises(VulnerabilityJobException, job.run)

        self.assertEqual(
            job.metadata.get("result"),
            {
                "succeeded": [],
                "failed": [],
                "error_description": ["Git ref not found"],
            },
        )

    def test_run_import_with_wrong_blob(self):
        """Run ImportVulnerabilityJob with a blob that is not a cve record.
        This will not raise an exception, it will only not be imported.
        """
        wrong_blob = b"wrong:\n- blob"
        self.useFixture(
            GitHostingFixture(
                blob=wrong_blob,
                refs=self.refs,
                diff_stats={"added": ["cves/CVE-2025-1979"]},
            )
        )

        cve = self.factory.makeCVE("2025-1979")
        self.factory.makeDistribution(name="soss")

        job = self.job_source.create(
            handler=VulnerabilityHandlerEnum.SOSS,
            git_repository=self.repository.git_https_url,
            git_ref="ref/tags/v1.0",
            git_paths=["cves"],
            information_type=InformationType.PRIVATESECURITY.value,
            import_since_commit_sha1=None,
        )
        job.run()

        # Check that it did not create the bug and vulnerability
        self.assertEqual(len(cve.bugs), 0)

        admin = getUtility(ILaunchpadCelebrities).admin
        with person_logged_in(admin):
            self.assertEqual(len(list(cve.vulnerabilities)), 0)

        self.assertEqual(
            job.metadata.get("result"),
            {
                "succeeded": [],
                "failed": [],
                "error_description": ["None is not a valid PriorityEnum"],
            },
        )

    def test_run_import_with_import_since_commit_sha1(self):
        """Run ImportVulnerabilityJob using import_since_commit_sha1"""
        with open(self.cve_path, encoding="utf-8") as file:
            self.useFixture(
                GitHostingFixture(
                    blob=file.read(),
                    refs=self.refs,
                    diff_stats={"added": ["cves/CVE-2025-1979"]},
                )
            )

        cve = self.factory.makeCVE("2025-1979")
        self.factory.makeDistribution(name="soss")

        job = self.job_source.create(
            handler=VulnerabilityHandlerEnum.SOSS,
            git_repository=self.repository.git_https_url,
            git_ref="ref/tags/v1.0",
            git_paths=["cves"],
            information_type=InformationType.PRIVATESECURITY.value,
            import_since_commit_sha1="1" * 40,
        )
        job.run()

        # Check that it created the bug and vulnerability
        self.assertEqual(len(cve.bugs), 1)

        admin = getUtility(ILaunchpadCelebrities).admin
        with person_logged_in(admin):
            self.assertEqual(len(list(cve.vulnerabilities)), 1)

        self.assertEqual(
            job.metadata.get("result"),
            {
                "succeeded": ["CVE-2025-1979"],
                "failed": [],
                "error_description": [],
            },
        )

    def test_get(self):
        """ImportVulnerabilityJob.get() returns the import job for the given
        handler.
        """
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None

        # There is no job before creating it
        self.assertIs(None, self.job_source.get(handler))

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        job_gotten = self.job_source.get(handler)

        self.assertIsInstance(job, ImportVulnerabilityJob)
        self.assertEqual(job, job_gotten)

    def test_error_description_when_no_error(self):
        """The ImportVulnerabilityJob.error_description property returns
        None when no error description is recorded."""
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        self.assertEqual([], removeSecurityProxy(job).error_description)

    def test_error_description_set_when_notifying_about_user_errors(self):
        """Test that error_description is set by notifyUserError()."""
        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None

        job = self.job_source.create(
            handler,
            git_repository,
            git_ref,
            git_paths,
            information_type,
            import_since_commit_sha1,
        )
        message = "This is an example message."
        job.notifyUserError(VulnerabilityJobException(message))
        self.assertEqual([message], removeSecurityProxy(job).error_description)


class TestViaCelery(TestCaseWithFactory):
    layer = CeleryJobLayer

    def setUp(self):
        super().setUp()
        self.repository = self.factory.makeGitRepository()
        self.refs = self.factory.makeGitRefs(
            repository=self.repository,
            paths=("ref/heads/main", "ref/tags/v1.0"),
        )

    def test_job(self):
        """Job runs via Celery."""
        self.factory.makeCVE("2025-1979")
        transaction.commit()

        fixture = FeatureFixture(
            {
                "jobs.celery.enabled_classes": "ImportVulnerabilityJob",
            }
        )
        self.useFixture(fixture)
        job_source = getUtility(IImportVulnerabilityJobSource)

        handler = VulnerabilityHandlerEnum.SOSS
        git_repository = self.repository.git_https_url
        git_ref = "ref/heads/main"
        git_paths = ["cves"]
        information_type = InformationType.PRIVATESECURITY.value
        import_since_commit_sha1 = None
        metadata = {
            "request": {
                "git_repository": git_repository,
                "git_ref": git_ref,
                "git_paths": git_paths,
                "information_type": information_type,
                "import_since_commit_sha1": import_since_commit_sha1,
            },
            "result": {
                "error_description": [],
                "succeeded": [],
                "failed": [],
            },
        }

        with block_on_job():
            job_source.create(
                handler,
                git_repository,
                git_ref,
                git_paths,
                information_type,
                import_since_commit_sha1,
            )
            transaction.commit()

        job = job_source.get(handler)
        self.assertEqual(job.handler, handler)
        self.assertEqual(job.metadata, metadata)
