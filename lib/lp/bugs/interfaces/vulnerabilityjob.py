# Copyright 2025 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

__all__ = [
    "VulnerabilityJobType",
    "IVulnerabilityJob",
    "VulnerabilityJobInProgress",
    "VulnerabilityJobException",
    "IImportVulnerabilityJobSource",
    "IImportVulnerabilityJob",
    "IExportVulnerabilityJobSource",
    "IExportVulnerabilityJob",
]

from lazr.enum import DBEnumeratedType, DBItem
from zope.interface import Attribute, Interface
from zope.schema import Choice, Int, Object, Text

from lp import _
from lp.bugs.enums import VulnerabilityHandlerEnum
from lp.services.job.interfaces.job import IJob, IJobSource, IRunnableJob


class VulnerabilityJobType(DBEnumeratedType):
    IMPORT_DATA = DBItem(
        1,
        """
        Import Vulnerability data

        This job imports Vulnerability data from the format given by the
        handler.
        """,
    )

    EXPORT_DATA = DBItem(
        2,
        """
        Export Vulnerability data

        This job exports Vulnerability data to the format given by the hanlder.
        """,
    )


class IVulnerabilityJob(Interface):
    """A Job that acts on vulnerabilities."""

    id = Int(
        title=_("DB ID"),
        required=True,
        readonly=True,
        description=_("The tracking number for this job."),
    )

    handler = Choice(
        title=_("The handler for this job."),
        vocabulary=VulnerabilityHandlerEnum,
        required=True,
        readonly=True,
    )

    job_type = Choice(
        title=_("Job type"),
        vocabulary=VulnerabilityJobType,
        required=True,
        readonly=True,
    )

    job = Object(
        title=_("The common Job attributes"), schema=IJob, required=True
    )

    metadata = Attribute("A dict of data about the job.")

    def destroySelf():
        """Destroy this object."""

    def info(self) -> dict:
        """Retrieve information about the job.

        :return: A dict of information about the job.
        """


class VulnerabilityJobInProgress(Exception):
    """The VulnerabilityJob for the handler is already in progress."""

    def __init__(self, job):
        super().__init__()
        self.job = job


class VulnerabilityJobException(Exception):
    """There was an error during VulnerabilityJob creation."""


class IImportVulnerabilityJobSource(IJobSource):
    """An interface for acquiring IImportVulnerabilityJobs."""

    def create(
        handler,
        git_repository,
        git_ref,
        git_paths,
        information_type,
        import_since_commit_sha1,
    ):
        """Create a new import job for a handler."""

    def get(handler):
        """Retrieve the import job for a handler, if any.

        :return: `None` or an `IImportVulnerabilityJob`.
        """


class IImportVulnerabilityJob(IRunnableJob):
    """A Job that imports SVT data."""

    error_description = Text(
        title=_("Error description"),
        description=_(
            "A short description of the last error this "
            "job encountered, if any."
        ),
        readonly=True,
        required=False,
    )


class IExportVulnerabilityJobSource(IJobSource):
    """An interface for acquiring IExportVulnerabilityJob."""

    def create(
        handler,
        sources,
    ):
        """Create a new export job for sources using a handler."""

    def get(handler):
        """Retrieve the export job for a handler, if any.

        :return: `None` or an `IExportVulnerabilityJob`.
        """


class IExportVulnerabilityJob(IRunnableJob):
    """A Job that exports SVT data."""

    error_description = Text(
        title=_("Error description"),
        description=_(
            "A short description of the last error this "
            "job encountered, if any."
        ),
        readonly=True,
        required=False,
    )
